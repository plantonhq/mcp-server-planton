// Code generated by schema2go. DO NOT EDIT.
// Generated: 2026-02-26T22:01:03+05:30

package openstack

import (
	"encoding/json"
	"fmt"

	"github.com/plantoncloud/mcp-server-planton/internal/parse"
	"google.golang.org/protobuf/types/known/structpb"
)

var (
	_ = json.Marshal
	_ = fmt.Errorf
	_ = parse.ValidateHeader
	_ = (*structpb.Struct)(nil)
)

// OpenStackApplicationCredential is a Kubernetes Resource Model (KRM) style
//
//	resource for managing OpenStack Identity application credentials.
//
//	Application credentials allow applications to authenticate to OpenStack
//	without using a user's password. They are scoped to the project that was
//	active during creation and can be restricted to specific roles and API
//	access patterns.
//
//	IMPORTANT: This is an immutable resource. Any change to the spec requires
//	destroying and recreating the credential, which generates a new secret.
type OpenStackApplicationCredentialSpecInput struct {
	// description is a human-readable description of the application credential.
	//  ForceNew: cannot be changed after creation.
	Description string `json:"description,omitempty" jsonschema:"description is a human-readable description of the application credential. ForceNew: cannot be changed after creation."`
	// unrestricted controls whether the application credential can create
	//  additional application credentials or trusts.
	//  Default: false (restricted). Setting to true is a security risk --
	//  an unrestricted credential can be used to create sub-credentials.
	//  ForceNew: cannot be changed after creation.
	Unrestricted bool `json:"unrestricted,omitempty" jsonschema:"unrestricted controls whether the application credential can create additional application credentials or trusts. Default: false (restricted). Setting to true is a security risk -- an unrestricted cre..."`
	// secret is the application credential secret.
	//  If omitted, OpenStack generates a random secret.
	//  If provided, the user-specified secret is used.
	//  ForceNew: cannot be changed after creation.
	//  The secret is sensitive and should be stored securely.
	Secret string `json:"secret,omitempty" jsonschema:"secret is the application credential secret. If omitted; OpenStack generates a random secret. If provided; the user-specified secret is used. ForceNew: cannot be changed after creation. The secret is ..."`
	// roles is a list of role names to scope the application credential.
	//  The credential can only perform actions allowed by these roles.
	//  If omitted, the credential inherits all roles of the creating user
	//  on the current project.
	//  ForceNew: cannot be changed after creation.
	Roles []string `json:"roles,omitempty" jsonschema:"roles is a list of role names to scope the application credential. The credential can only perform actions allowed by these roles. If omitted; the credential inherits all roles of the creating user on..."`
	// access_rules restricts the credential to specific API operations.
	//  Each rule specifies a service, HTTP method, and URL path pattern.
	//  When set, the credential can ONLY call the specified APIs.
	//  ForceNew: cannot be changed after creation.
	AccessRules []*AccessRuleInput `json:"access_rules,omitempty" jsonschema:"access_rules restricts the credential to specific API operations. Each rule specifies a service; HTTP method; and URL path pattern. When set; the credential can ONLY call the specified APIs. ForceNew:..."`
	// expires_at is the expiration timestamp in RFC3339 format.
	//  After this time, the credential becomes invalid.
	//  If omitted, the credential does not expire.
	//  ForceNew: cannot be changed after creation.
	//  Example: "2027-01-01T00:00:00Z"
	ExpiresAt string `json:"expires_at,omitempty" jsonschema:"expires_at is the expiration timestamp in RFC3339 format. After this time; the credential becomes invalid. If omitted; the credential does not expire. ForceNew: cannot be changed after creation. Examp..."`
	// region overrides the region from the provider config.
	//  If omitted, the region from the OpenStack provider config is used.
	//  Example: "RegionOne"
	Region string `json:"region,omitempty" jsonschema:"region overrides the region from the provider config. If omitted; the region from the OpenStack provider config is used. Example: 'RegionOne'"`
}

func (s *OpenStackApplicationCredentialSpecInput) validate() error {
	for i, v := range s.AccessRules {
		if v != nil {
			if err := v.validate(); err != nil {
				return fmt.Errorf("access_rules[%d]: %w", i, err)
			}
		}
	}
	return nil
}

func (s *OpenStackApplicationCredentialSpecInput) applyDefaults() {
}

func (s *OpenStackApplicationCredentialSpecInput) toMap() map[string]any {
	m := make(map[string]any)
	if s.Description != "" {
		m["description"] = s.Description
	}
	if s.Unrestricted {
		m["unrestricted"] = s.Unrestricted
	}
	if s.Secret != "" {
		m["secret"] = s.Secret
	}
	if len(s.Roles) > 0 {
		m["roles"] = s.Roles
	}
	if len(s.AccessRules) > 0 {
		items := make([]any, len(s.AccessRules))
		for i, v := range s.AccessRules {
			if v != nil {
				items[i] = v.toMap()
			}
		}
		m["access_rules"] = items
	}
	if s.ExpiresAt != "" {
		m["expires_at"] = s.ExpiresAt
	}
	if s.Region != "" {
		m["region"] = s.Region
	}
	return m
}

// AccessRule restricts an application credential to a specific API operation.
//
//	Each rule specifies:
//	  - service: the OpenStack service type (e.g., "compute", "identity", "block-storage")
//	  - method: the HTTP method (e.g., "GET", "POST")
//	  - path: the URL path pattern (e.g., "/v3/projects", "/v2.1/servers/*")
//
//	When access_rules are set on an application credential, the credential
//	can ONLY call the matching APIs.
type AccessRuleInput struct {
	// path is the URL path pattern for the API endpoint.
	//  Supports wildcards: "/v2.1/servers/*" matches all server sub-paths.
	//  Required.
	Path string `json:"path,omitempty" jsonschema:"path is the URL path pattern for the API endpoint. Supports wildcards: '/v2.1/servers/*' matches all server sub-paths. Required."`
	// method is the HTTP method allowed for this rule.
	//  Must be one of the standard HTTP methods.
	//  Required.
	Method string `json:"method,omitempty" jsonschema:"method is the HTTP method allowed for this rule. Must be one of the standard HTTP methods. Required."`
	// service is the OpenStack service type for this rule.
	//  Examples: "identity", "compute", "block-storage", "image", "network"
	//  Required.
	Service string `json:"service,omitempty" jsonschema:"service is the OpenStack service type for this rule. Examples: 'identity'; 'compute'; 'block-storage'; 'image'; 'network' Required."`
}

func (s *AccessRuleInput) validate() error {
	return nil
}

func (s *AccessRuleInput) applyDefaults() {
}

func (s *AccessRuleInput) toMap() map[string]any {
	m := make(map[string]any)
	if s.Path != "" {
		m["path"] = s.Path
	}
	if s.Method != "" {
		m["method"] = s.Method
	}
	if s.Service != "" {
		m["service"] = s.Service
	}
	return m
}

// ParseOpenStackApplicationCredential validates and normalizes a OpenStackApplicationCredential cloud_object.
func ParseOpenStackApplicationCredential(cloudObject map[string]any) (*structpb.Struct, error) {
	if err := parse.ValidateHeader(cloudObject, "openstack.openmcf.org/v1", "OpenStackApplicationCredential"); err != nil {
		return nil, err
	}

	specMap, err := parse.ExtractSpecMap(cloudObject)
	if err != nil {
		return nil, err
	}

	specBytes, err := json.Marshal(specMap)
	if err != nil {
		return nil, fmt.Errorf("marshal spec: %w", err)
	}

	var spec OpenStackApplicationCredentialSpecInput
	if err := json.Unmarshal(specBytes, &spec); err != nil {
		return nil, fmt.Errorf("invalid spec: %w", err)
	}

	if err := spec.validate(); err != nil {
		return nil, err
	}

	spec.applyDefaults()

	return parse.RebuildCloudObject(cloudObject, spec.toMap())
}
