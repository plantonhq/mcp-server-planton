// Code generated by schema2go. DO NOT EDIT.
// Generated: 2026-02-26T22:01:03+05:30

package oci

import (
	"encoding/json"
	"fmt"

	"github.com/plantoncloud/mcp-server-planton/internal/parse"
	"google.golang.org/protobuf/types/known/structpb"
)

var (
	_ = json.Marshal
	_ = fmt.Errorf
	_ = parse.ValidateHeader
	_ = (*structpb.Struct)(nil)
)

// OciDynamicGroup is the top-level resource representing an Oracle Cloud
//
//	Infrastructure dynamic group for granting OCI resources (compute instances,
//	functions, etc.) the ability to authenticate and call OCI APIs.
type OciDynamicGroupSpecInput struct {
	// OCID of the tenancy (root compartment).
	//  Dynamic groups are tenancy-level IAM resources and must be created
	//  in the tenancy compartment, not a child compartment.
	CompartmentId string `json:"compartment_id" jsonschema:"required,OCID of the tenancy (root compartment). Dynamic groups are tenancy-level IAM resources and must be created in the tenancy compartment; not a child compartment."`
	// Name assigned to the dynamic group.
	//  Must be unique across all groups (including user groups) in the tenancy
	//  and cannot be changed after creation.
	//  Falls back to metadata.name if not provided.
	Name string `json:"name,omitempty" jsonschema:"Name assigned to the dynamic group. Must be unique across all groups (including user groups) in the tenancy and cannot be changed after creation. Falls back to metadata.name if not provided."`
	// Description of the dynamic group's purpose.
	//  Required by the OCI API. Updatable after creation.
	Description string `json:"description,omitempty" jsonschema:"Description of the dynamic group's purpose. Required by the OCI API. Updatable after creation."`
	// Matching rule that defines which resources belong to this dynamic group.
	//  Uses OCI's rule syntax, e.g.:
	//    "Any {instance.compartment.id = 'ocid1.compartment.oc1..xxx'}"
	//    "All {resource.type = 'fnfunc', resource.compartment.id = 'ocid1...'}"
	//  See https://docs.oracle.com/iaas/Content/Identity/Tasks...
	MatchingRule string `json:"matching_rule,omitempty" jsonschema:"Matching rule that defines which resources belong to this dynamic group. Uses OCI's rule syntax; e.g.: 'Any {instance.compartment.id = 'ocid1.compartment.oc1..xxx'}' 'All {resource.type = 'fnfunc'; re..."`
}

func (s *OciDynamicGroupSpecInput) validate() error {
	if s.CompartmentId == "" {
		return fmt.Errorf("compartment_id is required")
	}
	return nil
}

func (s *OciDynamicGroupSpecInput) applyDefaults() {
}

func (s *OciDynamicGroupSpecInput) toMap() map[string]any {
	m := make(map[string]any)
	m["compartment_id"] = s.CompartmentId
	if s.Name != "" {
		m["name"] = s.Name
	}
	if s.Description != "" {
		m["description"] = s.Description
	}
	if s.MatchingRule != "" {
		m["matching_rule"] = s.MatchingRule
	}
	return m
}

// ParseOciDynamicGroup validates and normalizes a OciDynamicGroup cloud_object.
func ParseOciDynamicGroup(cloudObject map[string]any) (*structpb.Struct, error) {
	if err := parse.ValidateHeader(cloudObject, "oci.openmcf.org/v1", "OciDynamicGroup"); err != nil {
		return nil, err
	}

	specMap, err := parse.ExtractSpecMap(cloudObject)
	if err != nil {
		return nil, err
	}

	specBytes, err := json.Marshal(specMap)
	if err != nil {
		return nil, fmt.Errorf("marshal spec: %w", err)
	}

	var spec OciDynamicGroupSpecInput
	if err := json.Unmarshal(specBytes, &spec); err != nil {
		return nil, fmt.Errorf("invalid spec: %w", err)
	}

	if err := spec.validate(); err != nil {
		return nil, err
	}

	spec.applyDefaults()

	return parse.RebuildCloudObject(cloudObject, spec.toMap())
}
